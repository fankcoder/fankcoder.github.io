<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" /> <!--[if lte IE 9]><meta http-equiv="refresh" content="0;url=/ie.html"><![endif]--> <title>爬虫防屏蔽</title> <meta name="description" content="##介绍"> <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,400italic,600|Droid+Sans+Mono' rel='stylesheet' type='text/css'> <link rel="stylesheet" href="/css/main.css"> <link rel="canonical" href="http://localhost:4000/%E6%8A%80%E6%9C%AF/2016/01/25/amazon-spider-python.html"> <link rel="alternate" type="application/rss+xml" title="Fank" href="http://localhost:4000/feed.xml" /> <script src="/assets/js/prefixfree.js"></script> </head> <body> <aside id="sidebar"> <div id="sidebar-left"> <a id="sidebar-avatar" href="/"> <img id="sidebar-avatar-img" alt="" src="/assets/img/avatar.jpg"/> </a> <div id="sidebar-social"> <a href="/feed.xml" class="sidebar-social-icon feed"></a> <a href="mailto:fankcoder@gmail.com" class="sidebar-social-icon email"></a> <a href="https://github.com/https://github.com/fankcoder" class="sidebar-social-icon github" target="_blank"></a> </div> <ul id="sidebar-tags"> <li class="sidebar-tag active" data-filter="all">全部文章</li> <li class="sidebar-tag" data-filter="备忘">备忘</li> <li class="sidebar-tag" data-filter="工具">工具</li> <li class="sidebar-tag" data-filter="技术">技术</li> </ul> </div> <div id="sidebar-right"> <div id="search-box"> <input id="search-input" type="text" placeholder="Search" /> </div> <nav id="toc"> <a class="toc-link" data-tags="工具" href="/%E5%B7%A5%E5%85%B7/2019/03/08/vscode.html"> vscode配置手册 </a> <a class="toc-link" data-tags="工具" href="/%E5%B7%A5%E5%85%B7/2019/03/08/mac-tools.html"> mac使用手册 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2016/11/01/chmod.html"> chmod命令 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2016/03/10/screen-linux.html"> screen工具 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2016/03/08/todolist-django-python.html"> Todolist 应用 </a> <a class="toc-link" data-tags="备忘" href="/%E5%A4%87%E5%BF%98/2016/03/04/general-linux-resources.html"> Linux 常用资源 </a> <a class="toc-link" data-tags="工具" href="/%E5%B7%A5%E5%85%B7/2016/01/28/good-tools.html"> 神器收藏 </a> <a class="toc-link" data-tags="备忘" href="/%E5%A4%87%E5%BF%98/2016/01/27/general-django-resource.html"> Django命令备忘录 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2016/01/25/amazon-spider-python.html"> 爬虫防屏蔽 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2016/01/20/add-static-django-python.html"> Django添加静态文件 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2016/01/12/threading-python.html"> Python 多线程 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2016/01/11/encode-python.html"> Python转码问题 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2015/12/29/xrange-python.html"> Python的xrange和range </a> <a class="toc-link" data-tags="工具" href="/%E5%B7%A5%E5%85%B7/2015/11/10/vpn-tools.html"> 科学上网列表 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2015/10/26/email-shell-linux.html"> Shell每日发邮件 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2015/10/13/passwd-python.html"> Python密码处理 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2015/10/12/os-python.html"> Python标准库os </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2015/08/25/re-python.html"> Python正则 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2015/08/11/func-python.html"> Python内置函数(map、reduce、filter) </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2015/07/25/awk-linux.html"> AWK </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2015/07/24/blog-django-python.html"> Django练习项目之搭建博客 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2015/05/22/xlrd-python.html"> 用xlrd\xlwt读写excel </a> <a class="toc-link" data-tags="备忘" href="/%E5%A4%87%E5%BF%98/2015/02/13/general-seo-resources.html"> SEO 常用资源 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2015/01/01/chromium-flash-linux.html"> chromium安装flash </a> <a class="toc-link" data-tags="工具" href="/%E5%B7%A5%E5%85%B7/2014/12/24/ubuntu-tools.html"> Ubuntu常用 </a> <a class="toc-link" data-tags="备忘" href="/%E5%A4%87%E5%BF%98/2014/09/15/general-git-resources.html"> Git 常用命令 </a> <a class="toc-link" data-tags="备忘" href="/%E5%A4%87%E5%BF%98/2014/08/03/general-mac-resources.html"> Mac 常用资源 </a> <a class="toc-link" data-tags="备忘" href="/%E5%A4%87%E5%BF%98/2014/05/11/general-mysql-resources.html"> MySQL常用资源 </a> <a class="toc-link" data-tags="备忘" href="/%E5%A4%87%E5%BF%98/2014/04/23/general-bootstrap-resources.html"> Bootstrap常用资源 </a> <a class="toc-link" data-tags="备忘" href="/%E5%A4%87%E5%BF%98/2014/01/15/general-svn-resources.html"> SVN 常用资源 </a> <a class="toc-link" data-tags="备忘" href="/%E5%A4%87%E5%BF%98/2014/01/15/general-shell-resources.html"> Shell 常用资源 </a> <a class="toc-link" data-tags="备忘" href="/%E5%A4%87%E5%BF%98/2014/01/15/general-python-resources.html"> Python 常用资源 </a> <a class="toc-link" data-tags="备忘" href="/%E5%A4%87%E5%BF%98/2014/01/15/general-php-resources.html"> PHP 常用资源 </a> <a class="toc-link" data-tags="备忘" href="/%E5%A4%87%E5%BF%98/2014/01/15/general-jquery-resources.html"> jQuery 常用资源 </a> <a class="toc-link" data-tags="备忘" href="/%E5%A4%87%E5%BF%98/2014/01/15/general-javascript-resources.html"> JavaScript 常用资源 </a> <a class="toc-link" data-tags="备忘" href="/%E5%A4%87%E5%BF%98/2014/01/15/general-html-resources.html"> HTML 常用 </a> </nav> </div> </aside> <main id="main"> <article class="post container"> <div class="post-meta"> <span class="post-meta-span date">2016 January 25</span> <span class="post-meta-span tag">python,spider</span> </div> <h1 class="post-title">爬虫防屏蔽</h1> <p>##介绍</p> <p>最近爬了amazon,发现amazon服务器,连续访问100多次后爬虫就会经常失败了,</p> <p>查找了下失败的原因,发现amazon会检测Ip一旦发现请求次数过多,就会跳转到输入验证码的网页</p> <p>需要输入正确验证码才可继续愉快的访问,搞掉验证码是个麻烦活,执意研究验证码就跨到图像分析那个学科了(不过据说某些库识别率还行)。。</p> <p>Gg整理正常的防屏蔽方法,总结一下比较好的解决方案.</p> <h4 id="adsl重启拨号">ADSL重启拨号</h4> <p>大家都知道adsl重拨号的话,会换一个新的ip地址,那就可以写脚本设置时间重拨adsl,或者先用爬虫爬着,发现开始跳转到验证码页面了,再调用重拨adsl的脚本</p> <h4 id="爬代理服务器地址">爬代理服务器地址</h4> <p>很机智的解决办法，代理服务器可以很好的解决ip被屏蔽的问题</p> <p>不过代理服务器的网站域名经常更换,我就不提供了,大家自行Gg吧,百度说不定也会有惊喜</p> <p>要注意的是爬下来的代理服务器,最好检测一下是否可用!</p> <p>参照下面篇博客的checkProxy()函数</p> <p>https://blog.linuxeye.com/410.html</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
#coding:utf-8
#BLOG: blog.linuxeye.com
</span><span class="kn">import</span> <span class="nn">urllib2</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">MySQLdb</span>
<span class="n">rawProxyList</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">checkedProxyList</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1">#抓取代理网站
</span><span class="n">targets</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">42</span><span class="p">):</span>
        <span class="n">target</span> <span class="o">=</span> <span class="s">r"http://www.proxy.com.ru/list_</span><span class="si">%</span><span class="s">d.html"</span> <span class="o">%</span> <span class="n">i</span>
        <span class="n">targets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
<span class="c1">#抓取代理服务器正则
</span><span class="n">p</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span><span class="s">r'''&lt;tr&gt;&lt;b&gt;&lt;td&gt;(\d+)&lt;/td&gt;&lt;td&gt;(.+?)&lt;/td&gt;&lt;td&gt;(\d+)&lt;/td&gt;&lt;td&gt;(.+?)&lt;/td&gt;&lt;td&gt;(.+?)&lt;/td&gt;&lt;/b&gt;&lt;/tr&gt;'''</span><span class="p">)</span>
<span class="c1">#获取代理的类
</span><span class="k">class</span> <span class="nc">ProxyGet</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">target</span><span class="p">):</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span>
    <span class="k">def</span> <span class="nf">getProxy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">"代理服务器目标网站： "</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="c1">#print chardet.detect(result)
</span>        <span class="n">matchs</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="c1">#       print matchs
</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">matchs</span><span class="p">:</span>
            <span class="n">ip</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">port</span> <span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">addr</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">"cp936"</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">"utf-8"</span><span class="p">)</span>
            <span class="n">proxy</span> <span class="o">=</span> <span class="p">[</span><span class="n">ip</span><span class="p">,</span><span class="n">port</span><span class="p">,</span><span class="n">addr</span><span class="p">]</span>
            <span class="k">print</span> <span class="n">proxy</span>
            <span class="n">rawProxyList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getProxy</span><span class="p">()</span>
<span class="c1">#检验代理的类
</span><span class="k">class</span> <span class="nc">ProxyCheck</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">proxyList</span><span class="p">):</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proxyList</span> <span class="o">=</span> <span class="n">proxyList</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testUrl</span> <span class="o">=</span> <span class="s">"http://www.baidu.com/"</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testStr</span> <span class="o">=</span> <span class="s">"030173"</span>
    <span class="k">def</span> <span class="nf">checkProxy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cookies</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">HTTPCookieProcessor</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">proxy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxyList</span><span class="p">:</span>
            <span class="n">proxyHandler</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">ProxyHandler</span><span class="p">({</span><span class="s">"http"</span> <span class="p">:</span> <span class="s">r'http://</span><span class="si">%</span><span class="s">s:</span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span><span class="p">(</span><span class="n">proxy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">proxy</span><span class="p">[</span><span class="mi">1</span><span class="p">])})</span>
            <span class="c1">#print r'http://%s:%s' %(proxy[0],proxy[1])
</span>            <span class="n">opener</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">build_opener</span><span class="p">(</span><span class="n">cookies</span><span class="p">,</span><span class="n">proxyHandler</span><span class="p">)</span>
            <span class="n">opener</span><span class="o">.</span><span class="n">addheaders</span> <span class="o">=</span> <span class="p">[(</span><span class="s">'User-agent'</span><span class="p">,</span> <span class="s">'Mozilla/5.0 (Windows NT 6.2; WOW64; rv:22.0) Gecko/20100101 Firefox/22.0'</span><span class="p">)]</span>
            <span class="c1">#urllib2.install_opener(opener)
</span>            <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1">#req = urllib2.urlopen("http://www.baidu.com", timeout=self.timeout)
</span>                <span class="n">req</span> <span class="o">=</span> <span class="n">opener</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testUrl</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
                <span class="c1">#print "urlopen is ok...."
</span>                <span class="n">result</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="c1">#print "read html...."
</span>                <span class="n">timeused</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t1</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testStr</span><span class="p">)</span>
                <span class="c1">#print "pos is %s" %pos
</span>                <span class="k">if</span> <span class="n">pos</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">checkedProxyList</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">proxy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">proxy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">proxy</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">timeused</span><span class="p">))</span>
                    <span class="c1">#print "ok ip: %s %s %s %s" %(proxy[0],proxy[1],proxy[2],timeused)
</span>                <span class="k">else</span><span class="p">:</span>
                     <span class="k">continue</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                <span class="c1">#print e.message
</span>                <span class="k">continue</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkProxy</span><span class="p">()</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">getThreads</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">checkThreads</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1">#对每个目标网站开启一个线程负责抓取代理
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">ProxyGet</span><span class="p">(</span><span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">getThreads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">getThreads</span><span class="p">)):</span>
    <span class="n">getThreads</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">getThreads</span><span class="p">)):</span>
    <span class="n">getThreads</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
<span class="k">print</span> <span class="s">'.'</span><span class="o">*</span><span class="mi">10</span><span class="o">+</span><span class="s">"总共抓取了</span><span class="si">%</span><span class="s">s个代理"</span> <span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">rawProxyList</span><span class="p">)</span> <span class="o">+</span><span class="s">'.'</span><span class="o">*</span><span class="mi">10</span>
<span class="c1">#开启20个线程负责校验，将抓取到的代理分成20份，每个线程校验一份
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">ProxyCheck</span><span class="p">(</span><span class="n">rawProxyList</span><span class="p">[((</span><span class="nb">len</span><span class="p">(</span><span class="n">rawProxyList</span><span class="p">)</span><span class="o">+</span><span class="mi">19</span><span class="p">)</span><span class="o">/</span><span class="mi">20</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span><span class="p">:((</span><span class="nb">len</span><span class="p">(</span><span class="n">rawProxyList</span><span class="p">)</span><span class="o">+</span><span class="mi">19</span><span class="p">)</span><span class="o">/</span><span class="mi">20</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>
    <span class="n">checkThreads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">checkThreads</span><span class="p">)):</span>
    <span class="n">checkThreads</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">checkThreads</span><span class="p">)):</span>
    <span class="n">checkThreads</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
<span class="k">print</span> <span class="s">'.'</span><span class="o">*</span><span class="mi">10</span><span class="o">+</span><span class="s">"总共有</span><span class="si">%</span><span class="s">s个代理通过校验"</span> <span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">checkedProxyList</span><span class="p">)</span> <span class="o">+</span><span class="s">'.'</span><span class="o">*</span><span class="mi">10</span>
<span class="c1">#插入数据库，表结构自己创建，四个字段ip,port,speed,address
</span><span class="k">def</span> <span class="nf">db_insert</span><span class="p">(</span><span class="n">insert_list</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">"localhost"</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="s">"root"</span><span class="p">,</span> <span class="n">passwd</span><span class="o">=</span><span class="s">"admin"</span><span class="p">,</span><span class="n">db</span><span class="o">=</span><span class="s">"m_common"</span><span class="p">,</span><span class="n">charset</span><span class="o">=</span><span class="s">'utf8'</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'delete from proxy'</span><span class="p">)</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'alter table proxy AUTO_INCREMENT=1'</span><span class="p">)</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="s">"INSERT INTO proxy(ip,port,speed,address) VALUES (</span><span class="si">%</span><span class="s">s,</span><span class="si">%</span><span class="s">s,</span><span class="si">%</span><span class="s">s,</span><span class="si">%</span><span class="s">s)"</span><span class="p">,</span><span class="n">insert_list</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">Error</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">"Mysql Error </span><span class="si">%</span><span class="s">d: </span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="c1">#代理排序持久化
</span><span class="n">proxy_ok</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">f</span><span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">"proxy_list.txt"</span><span class="p">,</span><span class="s">'w+'</span><span class="p">)</span>
<span class="k">for</span> <span class="n">proxy</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">checkedProxyList</span><span class="p">,</span><span class="nb">cmp</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span><span class="nb">cmp</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">y</span><span class="p">[</span><span class="mi">3</span><span class="p">])):</span>
    <span class="k">if</span> <span class="n">proxy</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
        <span class="c1">#print "checked proxy is: %s:%s\t%s\t%s" %(proxy[0],proxy[1],proxy[2],proxy[3])
</span>        <span class="n">proxy_ok</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">proxy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">proxy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">proxy</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">proxy</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">"</span><span class="si">%</span><span class="s">s:</span><span class="si">%</span><span class="s">s</span><span class="se">\t</span><span class="si">%</span><span class="s">s</span><span class="se">\t</span><span class="si">%</span><span class="s">s</span><span class="se">\n</span><span class="s">"</span><span class="o">%</span><span class="p">(</span><span class="n">proxy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">proxy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">proxy</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">proxy</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">db_insert</span><span class="p">(</span><span class="n">proxy_ok</span><span class="p">)</span>

</code></pre></div></div> <p>想了解我的amazon爬虫?</p> <p>代码在github spider-comments项目下的amazon-spider-comments</p> <p>https://github.com/fankcoder/spider-comments</p> </article> <div class="post-share"> <div class="container"> <a href="https://twitter.com/share?url=http://localhost:4000/%E6%8A%80%E6%9C%AF/2016/01/25/amazon-spider-python.html&text=爬虫防屏蔽" target="_blank" class="post-share-icon twitter"></a> <a href="https://www.evernote.com/clip.action?url=http://localhost:4000/%E6%8A%80%E6%9C%AF/2016/01/25/amazon-spider-python.html&title=爬虫防屏蔽" target="_blank" class="post-share-icon evernote"></a> <a href="http://service.weibo.com/share/share.php?url=http://localhost:4000/%E6%8A%80%E6%9C%AF/2016/01/25/amazon-spider-python.html&title=爬虫防屏蔽" target="_blank" class="post-share-icon weibo"></a> </div> </div> <div class="footer"> <div class="container"> <p class="footer-entry">All content is licensed under <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA</a></p> <p class="footer-entry">Buit with <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> and <a href="https://github.com/P233/3-Jekyll" target="_blank">3-Jekyll theme</a> • Hosted on <a href="https://pages.github.com/" target="_blank">Github</a></p> </div> </div> </main> <button id="menu"> <span id="menu-icons"></span> </button> <script src="/assets/js/jquery-2.1.3.min.js"></script> <script src="/assets/js/jquery.pjax.js"></script> <script src="/assets/js/nprogress.js"></script> <script src="/assets/js/main.js"></script> </body> </html>
