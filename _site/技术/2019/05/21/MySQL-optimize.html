<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" /> <!--[if lte IE 9]><meta http-equiv="refresh" content="0;url=/ie.html"><![endif]--> <title>MySQL亿级表优化</title> <meta name="description" content="场景"> <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,400italic,600|Droid+Sans+Mono' rel='stylesheet' type='text/css'> <link rel="stylesheet" href="/css/main.css"> <link rel="canonical" href="http://localhost:4000/%E6%8A%80%E6%9C%AF/2019/05/21/MySQL-optimize.html"> <link rel="alternate" type="application/rss+xml" title="Fank" href="http://localhost:4000/feed.xml" /> <script src="/assets/js/prefixfree.js"></script> </head> <body> <aside id="sidebar"> <div id="sidebar-left"> <a id="sidebar-avatar" href="/"> <img id="sidebar-avatar-img" alt="" src="/assets/img/avatar.jpg"/> </a> <div id="sidebar-social"> <a href="/feed.xml" class="sidebar-social-icon feed"></a> <a href="mailto:fankcoder@gmail.com" class="sidebar-social-icon email"></a> <a href="http://www.weibo.com/u/2424646683" class="sidebar-social-icon weibo" target="_blank"></a> <a href="https://github.com/fankcoder" class="sidebar-social-icon github" target="_blank"></a> </div> <ul id="sidebar-tags"> <li class="sidebar-tag active" data-filter="all">全部文章</li> <li class="sidebar-tag" data-filter="备忘">备忘</li> <li class="sidebar-tag" data-filter="工具">工具</li> <li class="sidebar-tag" data-filter="技术">技术</li> <li class="sidebar-tag" data-filter="生活">生活</li> <li class="sidebar-tag" data-filter="About">About</li> </ul> </div> <div id="sidebar-right"> <div id="search-box"> <input id="search-input" type="text" placeholder="Search" /> </div> <nav id="toc"> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2019/05/21/MySQL-optimize.html"> MySQL亿级表优化 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2019/05/01/django-drf-learn.html"> Django深入学习笔记 </a> <a class="toc-link" data-tags="工具" href="/%E5%B7%A5%E5%85%B7/2019/04/28/fix-chrome-darkmode.html"> 在mojave深色模式下，禁用chrome的深色主题 </a> <a class="toc-link" data-tags="备忘" href="/%E5%A4%87%E5%BF%98/2019/04/04/general-docker.html"> Docker 常用 </a> <a class="toc-link" data-tags="工具" href="/%E5%B7%A5%E5%85%B7/2019/04/02/ss_config.html"> 第N次折腾vps科学上网，解决方案笔记 </a> <a class="toc-link" data-tags="工具" href="/%E5%B7%A5%E5%85%B7/2019/03/08/vscode.html"> vscode配置手册 </a> <a class="toc-link" data-tags="工具" href="/%E5%B7%A5%E5%85%B7/2019/03/08/mac-tools.html"> mac使用手册 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2019/03/08/python-deep.html"> Python深入学习笔记 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2019/03/08/appspider-tools.html"> Ubuntu&OSX的app抓包方案 </a> <a class="toc-link" data-tags="About" href="/about/2019/03/08/HeyUFindMe.html"> Hey, U find me! </a> <a class="toc-link" data-tags="工具" href="/%E5%B7%A5%E5%85%B7/2019/02/01/vim.html"> vim使用手册 </a> <a class="toc-link" data-tags="备忘" href="/%E5%A4%87%E5%BF%98/2019/01/15/general-javascript-resources.html"> JavaScript 常用资源 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2019/01/12/threading-python.html"> Python线程&进程&协程&asyncio </a> <a class="toc-link" data-tags="备忘" href="/%E5%A4%87%E5%BF%98/2019/01/02/algorithem.html"> 算法&数据结构 </a> <a class="toc-link" data-tags="备忘" href="/%E5%A4%87%E5%BF%98/2019/01/01/SQL-pratice.html"> SQL练习 </a> <a class="toc-link" data-tags="生活" href="/%E7%94%9F%E6%B4%BB/2019/01/01/life-time-manage.html"> 时间和人生感悟 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2016/11/01/chmod.html"> chmod命令 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2016/03/10/screen-linux.html"> screen工具 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2016/03/08/todolist-django-python.html"> Todolist 应用 </a> <a class="toc-link" data-tags="备忘" href="/%E5%A4%87%E5%BF%98/2016/03/04/general-linux-resources.html"> Linux 常用资源 </a> <a class="toc-link" data-tags="工具" href="/%E5%B7%A5%E5%85%B7/2016/01/28/good-tools.html"> 神器收藏 </a> <a class="toc-link" data-tags="备忘" href="/%E5%A4%87%E5%BF%98/2016/01/27/general-django-resource.html"> Django命令备忘录 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2016/01/25/amazon-spider-python.html"> 爬虫防屏蔽 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2016/01/20/add-static-django-python.html"> Django添加静态文件 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2016/01/11/encode-python.html"> Python转码问题 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2015/12/29/xrange-python.html"> Python的xrange和range </a> <a class="toc-link" data-tags="工具" href="/%E5%B7%A5%E5%85%B7/2015/11/10/vpn-tools.html"> 科学上网列表 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2015/10/26/email-shell-linux.html"> Shell每日发邮件 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2015/10/13/passwd-python.html"> Python密码处理 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2015/10/12/os-python.html"> Python标准库os </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2015/08/25/re-python.html"> Python正则 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2015/08/11/func-python.html"> Python内置函数(map、reduce、filter) </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2015/07/25/awk-linux.html"> AWK </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2015/07/24/blog-django-python.html"> Django练习项目之搭建博客 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2015/05/22/xlrd-python.html"> 用xlrd\xlwt读写excel </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2015/01/01/chromium-flash-linux.html"> chromium安装flash </a> <a class="toc-link" data-tags="工具" href="/%E5%B7%A5%E5%85%B7/2014/12/24/ubuntu-tools.html"> Ubuntu常用 </a> <a class="toc-link" data-tags="备忘" href="/%E5%A4%87%E5%BF%98/2014/09/15/general-git-resources.html"> Git 常用命令 </a> <a class="toc-link" data-tags="备忘" href="/%E5%A4%87%E5%BF%98/2014/05/11/general-mysql-resources.html"> MySQL常用资源 </a> <a class="toc-link" data-tags="备忘" href="/%E5%A4%87%E5%BF%98/2014/04/23/general-bootstrap-resources.html"> Bootstrap常用资源 </a> <a class="toc-link" data-tags="备忘" href="/%E5%A4%87%E5%BF%98/2014/01/15/general-svn-resources.html"> SVN 常用资源 </a> <a class="toc-link" data-tags="备忘" href="/%E5%A4%87%E5%BF%98/2014/01/15/general-shell-resources.html"> Shell 常用资源 </a> <a class="toc-link" data-tags="备忘" href="/%E5%A4%87%E5%BF%98/2014/01/15/general-python-resources.html"> Python 常用资源 </a> <a class="toc-link" data-tags="备忘" href="/%E5%A4%87%E5%BF%98/2014/01/15/general-jquery-resources.html"> jQuery 常用资源 </a> <a class="toc-link" data-tags="备忘" href="/%E5%A4%87%E5%BF%98/2014/01/15/general-html-resources.html"> HTML 常用 </a> </nav> </div> </aside> <main id="main"> <article class="post container"> <div class="post-meta"> <span class="post-meta-span date">2019 May 21</span> <span class="post-meta-span tag">SQL</span> </div> <h1 class="post-title">MySQL亿级表优化</h1> <h2 id="场景">场景</h2> <p>对单表2亿数据进行查询优化，测试几种常见的优化方式，给出解决方案</p> <h2 id="设计之初">设计之初</h2> <p>设计之初需要考虑的问题很多。设备，存储引擎，分库分表（水平/垂直分表），表设计规范等</p> <h2 id="sql优化索引">SQL优化&amp;索引</h2> <h4 id="sql优化">SQL优化</h4> <p>常见的SQL优化：</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>使用limit对查询结果的记录进行限定
避免select *，将需要查找的字段列出来
使用连接（join）来代替子查询
拆分大的delete或insert语句
OR改写成IN
避免%xxx式查询
使用同类型进行比较，比如用'123'和'123'比，123和123比
</code></pre></div></div> <h4 id="联合索引">联合索引</h4> <p>查看列的离散程度离散度更高的索引应该放在联合索引的前面，因为离散度高索引的可选择性高。 要想使用联合索引查询，最左是必选项,建议将查询条件顺序与索引建立顺序先后一致</p> <h4 id="如何查看是否使用索引">如何查看是否使用索引</h4> <p>使用explain，可以通过输出的extra列来判断，对于一个索引覆盖查询，显示为using index,MySQL查询优化器在执行查询前会决定是否有索引覆盖查询</p> <h4 id="备注">备注</h4> <p>虽然使用索引能得到查询效率的提高,但是我们也必须注意到它的代价. 索引需要空间来 存储,也需要定期维护, 每当有记录在表中增减或索引列被修改时, 索引本身也会被修改. 这意味着每条记录的INSERT , DELETE , UPDATE将为此多付出4 , 5 次的磁盘I/O . 因为索引需要额外的存储空间和处理,那些不必要的索引反而会使查询反应时间变慢.</p> <p>值分布很稀少的字段不适合建索引，例如”性别”这种只有两三个值的字段</p> <h2 id="优化like">优化like</h2> <p>一般情况下不鼓励使用like操作，如果非使用不可，如何使用也是一个问题。like “%aaa%” 不会使用索引而like “aaa%”可以使用索引。 新增一列，存储该字段的反转。比如原字段是abcd，取反存储为dcba，查询%bcd改成查dcb%。</p> <h4 id="缺点">缺点</h4> <p>只能从头尾匹配，不能从中间匹配</p> <h2 id="创建view">创建view</h2> <p>根据业务情况，比如我的场景需要，每2s查询最近插入的5条数据，基于最近被插入或者经常被查询的数据创建view，通过做view来读写分离，写在table上，读在view表上</p> <h4 id="时间上的坑">时间上的坑</h4> <p>这里有个坑，如过是按照当天时间创建视图表</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>time &gt;= DATE_FORMAT(CURDATE(),'%Y-%m-%d %H:%i:%s');
</code></pre></div></div> <p>那么在当天的24点时刻，视图表就是一张空表。</p> <p>解决办法，将时间范围延长，改为昨天的23点</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>time &gt;= DATE_ADD(DATE_SUB(CURDATE(),INTERVAL 1 DAY),INTERVAL 23 HOUR);
</code></pre></div></div> <h2 id="count优化">COUNT优化</h2> <p>优化分页，使用下面语句代替count函数</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>explain select * from `table_name`;
</code></pre></div></div> <h4 id="缺点-1">缺点</h4> <p>explain的rows是一个大概值，测试了几组数据差的还挺多，并且要注意的是当查询分页超过实际行数，不会使用索引，查询速度会降低很多</p> <h2 id="删除过期数据">删除过期数据</h2> <p>比如删除100天以前的数据，每天2百万数据，防止一次删除过多造成表锁死，需要批量删除。</p> <h4 id="批量删除优化">批量删除优化</h4> <p>比起利用索引(time)删除数据，若改为id删除会有更好的速度。这里参考了一篇博客的方法，<a href="https://www.cnblogs.com/luckygxf/p/7128788.html">博客链接</a></p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1.找出符合条件的create_time的最大ID
select max(id) from table_name where create_time &lt; '2019-04-06'

2.接着按id删除
delete from table_name where id &lt; maxId limit 10000
</code></pre></div></div> <p>使用python脚本删除，并自己控制删除次数</p> <h2 id="亿级表优化解决方案">亿级表优化解决方案</h2> <ol> <li>用时间作为联合查询最左条件约束，查询时必选</li> <li>优化like语句 or not(最后没有选择优化Like，因为使用方案1之后比较了优化Like与不优化的查询时间差别不是很明显，就选择了更好的用户体验，支持模糊查询)</li> <li>对当天的数据创建视图，查询当天数据默认使用视图查询</li> <li>水平分表 量级：亿级 50 000 * 43 * 120=258 000 000 解释：一条线一天5万，一共43条线，最少保存120天 每天 50 000 * 43=2150000 按月份分为4张表，每张表约258 000 000/4=64500000 水平拆分为千万级</li> </ol> </article> <div class="post-share"> <div class="container"> <a href="https://twitter.com/share?url=http://localhost:4000/%E6%8A%80%E6%9C%AF/2019/05/21/MySQL-optimize.html&text=MySQL亿级表优化" target="_blank" class="post-share-icon twitter"></a> <a href="https://www.evernote.com/clip.action?url=http://localhost:4000/%E6%8A%80%E6%9C%AF/2019/05/21/MySQL-optimize.html&title=MySQL亿级表优化" target="_blank" class="post-share-icon evernote"></a> <a href="http://service.weibo.com/share/share.php?url=http://localhost:4000/%E6%8A%80%E6%9C%AF/2019/05/21/MySQL-optimize.html&title=MySQL亿级表优化" target="_blank" class="post-share-icon weibo"></a> </div> </div> <div class="footer"> <div class="container"> <p class="footer-entry">All content is licensed under <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA</a></p> <p class="footer-entry">Buit with <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> and <a href="https://github.com/P233/3-Jekyll" target="_blank">3-Jekyll theme</a> • Hosted on <a href="https://pages.github.com/" target="_blank">Github</a></p> </div> </div> </main> <button id="menu"> <span id="menu-icons"></span> </button> <script src="/assets/js/jquery-2.1.3.min.js"></script> <script src="/assets/js/jquery.pjax.js"></script> <script src="/assets/js/nprogress.js"></script> <script src="/assets/js/main.js"></script> <!-- --> </body> </html>
