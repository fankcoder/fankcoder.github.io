<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" /> <!--[if lte IE 9]><meta http-equiv="refresh" content="0;url=/ie.html"><![endif]--> <title>MySQL常用资源</title> <meta name="description" content="常用命令"> <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,400italic,600|Droid+Sans+Mono' rel='stylesheet' type='text/css'> <link rel="stylesheet" href="/css/main.css"> <link rel="canonical" href="http://localhost:4000/%E5%A4%87%E5%BF%98/2014/05/11/general-mysql-resources.html"> <link rel="alternate" type="application/rss+xml" title="Fank" href="http://localhost:4000/feed.xml" /> <script src="/assets/js/prefixfree.js"></script> </head> <body> <aside id="sidebar"> <div id="sidebar-left"> <a id="sidebar-avatar" href="/"> <img id="sidebar-avatar-img" alt="" src="/assets/img/avatar.jpg"/> </a> <div id="sidebar-social"> <a href="/feed.xml" class="sidebar-social-icon feed"></a> <a href="mailto:fankcoder@gmail.com" class="sidebar-social-icon email"></a> <a href="http://www.weibo.com/u/2424646683" class="sidebar-social-icon weibo" target="_blank"></a> <a href="https://github.com/fankcoder" class="sidebar-social-icon github" target="_blank"></a> </div> <ul id="sidebar-tags"> <li class="sidebar-tag active" data-filter="all">全部文章</li> <li class="sidebar-tag" data-filter="备忘">备忘</li> <li class="sidebar-tag" data-filter="工具">工具</li> <li class="sidebar-tag" data-filter="技术">技术</li> <li class="sidebar-tag" data-filter="生活">生活</li> <li class="sidebar-tag" data-filter="About">About</li> </ul> </div> <div id="sidebar-right"> <div id="search-box"> <input id="search-input" type="text" placeholder="Search" /> </div> <nav id="toc"> <a class="toc-link" data-tags="备忘" href="/%E5%A4%87%E5%BF%98/2019/04/04/general-docker.html"> Docker 常用 </a> <a class="toc-link" data-tags="工具" href="/%E5%B7%A5%E5%85%B7/2019/04/02/ss_config.html"> 第N次折腾vps科学上网，解决方案笔记 </a> <a class="toc-link" data-tags="工具" href="/%E5%B7%A5%E5%85%B7/2019/03/08/vscode.html"> vscode配置手册 </a> <a class="toc-link" data-tags="工具" href="/%E5%B7%A5%E5%85%B7/2019/03/08/mac-tools.html"> mac使用手册 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2019/03/08/python-deep.html"> Python深入学习笔记 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2019/03/08/appspider-tools.html"> Ubuntu&OSX的app抓包方案 </a> <a class="toc-link" data-tags="About" href="/about/2019/03/08/HeyUFindMe.html"> Hey, U find me! </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2019/01/12/threading-python.html"> Python线程&进程&协程&asyncio </a> <a class="toc-link" data-tags="生活" href="/%E7%94%9F%E6%B4%BB/2019/01/01/life-time-manage.html"> 时间和人生感悟 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2016/11/01/chmod.html"> chmod命令 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2016/03/10/screen-linux.html"> screen工具 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2016/03/08/todolist-django-python.html"> Todolist 应用 </a> <a class="toc-link" data-tags="备忘" href="/%E5%A4%87%E5%BF%98/2016/03/04/general-linux-resources.html"> Linux 常用资源 </a> <a class="toc-link" data-tags="工具" href="/%E5%B7%A5%E5%85%B7/2016/01/28/good-tools.html"> 神器收藏 </a> <a class="toc-link" data-tags="备忘" href="/%E5%A4%87%E5%BF%98/2016/01/27/general-django-resource.html"> Django命令备忘录 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2016/01/25/amazon-spider-python.html"> 爬虫防屏蔽 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2016/01/20/add-static-django-python.html"> Django添加静态文件 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2016/01/11/encode-python.html"> Python转码问题 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2015/12/29/xrange-python.html"> Python的xrange和range </a> <a class="toc-link" data-tags="工具" href="/%E5%B7%A5%E5%85%B7/2015/11/10/vpn-tools.html"> 科学上网列表 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2015/10/26/email-shell-linux.html"> Shell每日发邮件 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2015/10/13/passwd-python.html"> Python密码处理 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2015/10/12/os-python.html"> Python标准库os </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2015/08/25/re-python.html"> Python正则 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2015/08/11/func-python.html"> Python内置函数(map、reduce、filter) </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2015/07/25/awk-linux.html"> AWK </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2015/07/24/blog-django-python.html"> Django练习项目之搭建博客 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2015/05/22/xlrd-python.html"> 用xlrd\xlwt读写excel </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2015/01/01/chromium-flash-linux.html"> chromium安装flash </a> <a class="toc-link" data-tags="工具" href="/%E5%B7%A5%E5%85%B7/2014/12/24/ubuntu-tools.html"> Ubuntu常用 </a> <a class="toc-link" data-tags="备忘" href="/%E5%A4%87%E5%BF%98/2014/09/15/general-git-resources.html"> Git 常用命令 </a> <a class="toc-link" data-tags="备忘" href="/%E5%A4%87%E5%BF%98/2014/05/11/general-mysql-resources.html"> MySQL常用资源 </a> <a class="toc-link" data-tags="备忘" href="/%E5%A4%87%E5%BF%98/2014/04/23/general-bootstrap-resources.html"> Bootstrap常用资源 </a> <a class="toc-link" data-tags="备忘" href="/%E5%A4%87%E5%BF%98/2014/01/15/general-svn-resources.html"> SVN 常用资源 </a> <a class="toc-link" data-tags="备忘" href="/%E5%A4%87%E5%BF%98/2014/01/15/general-shell-resources.html"> Shell 常用资源 </a> <a class="toc-link" data-tags="备忘" href="/%E5%A4%87%E5%BF%98/2014/01/15/general-python-resources.html"> Python 常用资源 </a> <a class="toc-link" data-tags="备忘" href="/%E5%A4%87%E5%BF%98/2014/01/15/general-jquery-resources.html"> jQuery 常用资源 </a> <a class="toc-link" data-tags="备忘" href="/%E5%A4%87%E5%BF%98/2014/01/15/general-javascript-resources.html"> JavaScript 常用资源 </a> <a class="toc-link" data-tags="备忘" href="/%E5%A4%87%E5%BF%98/2014/01/15/general-html-resources.html"> HTML 常用 </a> </nav> </div> </aside> <main id="main"> <article class="post container"> <div class="post-meta"> <span class="post-meta-span date">2014 May 11</span> <span class="post-meta-span tag">MySQL</span> </div> <h1 class="post-title">MySQL常用资源</h1> <h2 id="常用命令">常用命令</h2> <h3 id="登录数据库">登录数据库</h3> <p>mysql -h localhost -uroot -p</p> <h3 id="导出数据库">导出数据库</h3> <p>mysqldump -uroot -p db &gt; db.sql</p> <h3 id="导入数据库">导入数据库</h3> <p>mysql -uroot -p db &lt; db.sql</p> <p>// or</p> <p>mysql -uroot -p db -e “source /path/to/db.sql”</p> <h3 id="开启远程登录">开启远程登录</h3> <p>grant all privileges on ss.* to ‘root’@’%’ indentified by ‘passoword’ with grant option;</p> <p>// or</p> <p>update user set Host=”%” and User=”root”</p> <p>// 注意%是不包含localhost的</p> <p>flush privileges;</p> <h3 id="创建用户">创建用户</h3> <p>CREATE USER ‘test’@’localhost’ IDENTIFIED BY ‘password’;</p> <p>grant all privileges on <em>.</em> to test@’localhost’ identified by ‘test’;</p> <h3 id="创建表">创建表</h3> <p>CREATE SCHEMA testdb DEFAULT CHARACTER SET utf8 COLLATE utf8_unicode_ci;</p> <h3 id="赋予数据库权限">赋予数据库权限</h3> <p>GRANT ALL ON testdb.* TO ‘test’@’localhost’;</p> <h3 id="查看表结构">查看表结构</h3> <p>desc 表名;</p> <h3 id="修改表名">修改表名</h3> <p>alter table t_book rename to bbb;</p> <h3 id="添加列">添加列：</h3> <p>alter table 表名 add column 列名 varchar(30);</p> <h3 id="删除列">删除列：</h3> <p>alter table 表名 drop column 列名;</p> <h3 id="清空mysql表中的记录有以下两种方法">清空mysql表中的记录有以下两种方法：</h3> <p>delete from 表名; 不删除id?没实验</p> <p>truncate table 表名; 删除主键id</p> <h3 id="复制表结构">复制表结构</h3> <p>create table b select * from users where 0;</p> <p>create table a like users;</p> <p>create table b select * from users limit 0;</p> <h3 id="复制表">复制表</h3> <p>create table c select * from users;</p> <h3 id="删除表名为myclass-的表">删除表名为MyClass 的表</h3> <p>drop table MyClass; //删除表名为MyClass 的表</p> <h3 id="select">SELECT</h3> <p>SELECT * FROM table LIMIT 5;</p> <p>select * from issu_info limit 7,6; 从第8条开始取,取6条</p> <p>SELECT name,LENGTH(name)</p> <p>FROM world</p> <p>WHERE LENGTH(name)=5 AND region=’Europe’</p> <h3 id="between">between</h3> <p>SELECT name, population</p> <p>FROM world</p> <p>WHERE population BETWEEN 1000000 AND 1250000</p> <h3 id="like">like</h3> <p>SELECT name FROM world</p> <p>WHERE name LIKE ‘%a’ OR name LIKE ‘%l’</p> <h3 id="and">and</h3> <p>SELECT name, area, population</p> <p>FROM world</p> <p>WHERE area &gt; 50000 AND population &lt; 10000000</p> <h3 id="and-not">and not</h3> <p>SELECT name,population,area FROM world</p> <p>WHERE (area&gt;3000000 or population&gt;250000000) and not (area&gt;3000000 and population&gt;250000000)</p> <h3 id="in">in</h3> <p>SELECT name, population/area</p> <p>FROM world</p> <p>WHERE name IN (‘China’, ‘Nigeria’, ‘France’, ‘Australia’)</p> <h3 id="case-when--then-elseend">case when … then …else…end</h3> <p>SELECT name,</p> <p>CASE WHEN continent=’Oceania’ THEN ‘Australasia’</p> <p>ELSE continent END</p> <p>FROM world</p> <p>WHERE name LIKE ‘N%’</p> <h3 id="多个when">多个when</h3> <p>SELECT name,</p> <p>CASE WHEN continent in (“Europe”,”Asia”) THEN “Eurasia”</p> <p>WHEN continent in (“North America”,”South America”,”Caribbean”) THEN “America” ELSE continent END</p> <p>FROM world WHERE name LIKE “A%” OR name LIKE “b%”</p> <h3 id="order-by--desc-由大到小排序">ORDER BY .. DESC 由大到小排序</h3> <p>SELECT winner,yr,subject FROM nobel</p> <p>where winner like ‘Sir%’ ORDER BY yr DESC, winner</p> <h3 id="复合查询">复合查询</h3> <p>SELECT DISTINCT yr</p> <p>FROM nobel</p> <p>WHERE subject=’Medicine’</p> <p>AND yr NOT IN(SELECT yr FROM nobel</p> <p>WHERE subject=’Literature’)</p> <p>AND yr NOT IN (SELECT yr FROM nobel</p> <p>WHERE subject=’Peace’)</p> <h3 id="round">Round</h3> <p>ROUND(7253.86, 0) -&gt; 7254</p> <p>ROUND(7253.86, 1) -&gt; 7253.9</p> <p>ROUND(7253.86,-3) -&gt; 7000</p> <h3 id="concat-将字符连在一起">CONCAT 将字符连在一起</h3> <p>SELECT CONCAT(region,name)</p> <p>FROM bbc</p> <p>select name,CONCAT(ROUND(100*population/(select population from world where name = ‘Germany’),0),’%’) from world</p> <p>where continent = ‘Europe’</p> <h3 id="all">ALL</h3> <p>SELECT name</p> <p>FROM world</p> <p>WHERE gdp &gt;ALL(SELECT gdp</p> <p>FROM world</p> <p>WHERE gdp&gt;0 and continent=’Europe’)</p> <p>每一个地区中面积最大的国家，引进x,y做对比</p> <p>SELECT continent, name, area FROM world x</p> <p>WHERE x.area &gt;= ALL</p> <p>(SELECT y.area FROM world y</p> <p>WHERE y.continent=x.continent</p> <p>AND area&gt;0)</p> <p>列出每个大洲和国家的名字第一个字母顺序排列。</p> <p>SELECT continent,name FROM world x</p> <p>WHERE x.name = (SELECT y.name FROM world y</p> <p>WHERE y.continent= x.continent order by name limit 1</p> <p>)</p> <h3 id="计算函数">计算函数</h3> <p>SUM, COUNT, MAX and AVG</p> <h3 id="distinct去重">distinct去重</h3> <p>SELECT DISTINCT region FROM bbc</p> <h3 id="order-by">ORDER BY</h3> <p>ASC or DESC for ascending (smallest first, largest last) //小，大</p> <h3 id="group-by-相同分为一组">GROUP BY 相同分为一组</h3> <p>SELECT continent, COUNT(name)</p> <p>FROM world</p> <p>GROUP BY continent</p> <h3 id="having">having</h3> <p>可以筛选成组后的各种数据，where字句在聚合前先筛选记录，也就是说作用在group by和having字句前。而 having子句在聚合后对组记录进行筛选。</p> <p>SELECT continent, SUM(population)</p> <p>FROM world</p> <p>GROUP BY continent</p> <p>HAVING SUM(population)&gt;500000000</p> <h3 id="join--on-多表关联查询">JOIN … ON 多表关联查询</h3> <p>SELECT games.yr, city.country</p> <p>FROM games JOIN city</p> <p>ON (games.city = city.name)</p> <p>SELECT goal.player,goal.teamid,game.stadium,game.mdate</p> <p>FROM game JOIN goal ON (game.id=goal.matchid) WHERE goal.teamid = ‘GER’</p> <h3 id="case-when">CASE WHEN</h3> <p>SELECT name, population</p> <p>,CASE WHEN population&lt;1000000</p> <p>THEN ‘small’</p> <p>WHEN population&lt;10000000</p> <p>THEN ‘medium’</p> <p>ELSE ‘large’</p> <p>END</p> <p>FROM bbc</p> <h3 id="left-join--on--可以包含左表空值">LEFT JOIN … ON … 可以包含左表空值</h3> <p>SELECT games.yr, city.country</p> <p>FROM games LEFT JOIN city</p> <p>ON (games.city = city.name)</p> <h3 id="insert">INSERT</h3> <p>INSERT INTO games(yr,city)</p> <p>VALUES (2012,’London’);</p> <p>INSERT SELECT</p> <p>INSERT INTO games(yr,city)</p> <p>SELECT yr+12, city FROM games;</p> <h3 id="update-更新已经存在的">UPDATE 更新已经存在的</h3> <p>UPDATE games SET city=’Paris’ WHERE yr = 2004;</p> <h3 id="delete">DELETE</h3> <p>DELETE FROM games WHERE yr=2000;</p> <h3 id="create并存入">CREATE并存入</h3> <p>CREATE TABLE games</p> <p>(yr INT NOT NULL PRIMARY KEY</p> <p>,city VARCHAR(20)</p> <p>);</p> <p>INSERT INTO games(yr,city) VALUES (2004,’Athens’);</p> <p>INSERT INTO games(yr,city) VALUES (2008,’Beijing’);</p> <p>INSERT INTO games(yr,city) VALUES (2012,’London’);</p> <p>SELECT * FROM games;</p> <h3 id="auto-increment-自动存入">auto-increment 自动存入</h3> <p>CREATE TABLE Persons</p> <p>(</p> <p>P_Id int NOT NULL AUTO_INCREMENT,</p> <p>LastName varchar(255) NOT NULL,</p> <p>FirstName varchar(255),</p> <p>Address varchar(255),</p> <p>City varchar(255),</p> <p>PRIMARY KEY (P_Id)</p> <p>)</p> <h3 id="primary-key">PRIMARY KEY</h3> <p>CREATE TABLE Persons</p> <p>(</p> <p>Id_P int NOT NULL,</p> <p>LastName varchar(255) NOT NULL,</p> <p>FirstName varchar(255),</p> <p>Address varchar(255),</p> <p>City varchar(255),</p> <p>PRIMARY KEY (Id_P)</p> <p>)</p> <h3 id="foreign-key">FOREIGN KEY</h3> <p>CREATE TABLE Orders</p> <p>(</p> <p>Id_O int NOT NULL,</p> <p>OrderNo int NOT NULL,</p> <p>Id_P int,</p> <p>PRIMARY KEY (Id_O),</p> <p>FOREIGN KEY (Id_P) REFERENCES Persons(Id_P)</p> <p>)</p> <h3 id="create-index">CREATE INDEX</h3> <p>CREATE INDEX index_name</p> <p>ON table_name (column_name)</p> <p>在表上创建一个唯一的索引。</p> <p>CREATE UNIQUE INDEX index_name</p> <p>ON table_name (column_name)</p> <h3 id="drop-index">DROP INDEX</h3> <p>ALTER TABLE table_name DROP INDEX index_name</p> <h3 id="alter-修改增加表的列">ALTER 修改，增加表的列</h3> <p>ALTER TABLE games ADD season VARCHAR(6);</p> <h3 id="unique约束">UNIQUE约束</h3> <p>CREATE TABLE Persons</p> <p>(</p> <p>Id_P int NOT NULL,</p> <p>LastName varchar(255) NOT NULL,</p> <p>FirstName varchar(255),</p> <p>Address varchar(255),</p> <p>City varchar(255),</p> <p>UNIQUE (Id_P)</p> <p>)</p> <hr /> <p>### update</p> <p>### 清空表</p> <p>清空mysql表中的记录有以下两种方法：</p> <p>delete from 表名; 不删除id?没实验</p> <p>truncate table 表名; 删除主键id</p> <h3 id="导出建表语句">导出建表语句</h3> <p>show create table tablename;</p> <h3 id="复制表结构-1">复制表结构</h3> <p>create table b select * from users where 0; //复制表结构</p> <p>create table a like users; //复制表结构</p> <p>create table b select * from users limit 0; //复制表结构</p> <p>create table c select * from users; //复制表的sql</p> <h3 id="排序">排序</h3> <p>ORDER BY .. DESC 由大到小排序</p> <p>SELECT winner,yr,subject FROM nobel</p> <p>where winner like ‘Sir%’ ORDER BY yr DESC, winner</p> <h3 id="复合查询-1">复合查询</h3> <p>SELECT DISTINCT yr</p> <p>FROM nobel</p> <p>WHERE subject=’Medicine’</p> <p>AND yr NOT IN(SELECT yr FROM nobel</p> <p>WHERE subject=’Literature’)</p> <p>AND yr NOT IN (SELECT yr FROM nobel</p> <p>WHERE subject=’Peace’)</p> <h3 id="round-1">Round</h3> <p>ROUND(7253.86, 0) -&gt; 7254</p> <p>ROUND(7253.86, 1) -&gt; 7253.9</p> <p>ROUND(7253.86,-3) -&gt; 7000</p> <h3 id="concat-将字符连在一起-1">CONCAT 将字符连在一起</h3> <p>SELECT CONCAT(region,name)</p> <p>FROM bbc</p> <p>select name,CONCAT(ROUND(100*population/(select population from world where name = ‘Germany’),0),’%’) from world</p> <p>where continent = ‘Europe’</p> <p>distinct去重</p> <p>SELECT DISTINCT region FROM bbc</p> <h3 id="having-1">having</h3> <p>having 可以让我们筛选成组后的各种数据，where字句在聚合前先筛选记录，也就是说作用在group by和having字句前。而 having子句在聚合后对组记录进行筛选。</p> <p>SELECT continent, SUM(population)</p> <p>FROM world</p> <p>GROUP BY continent</p> <p>HAVING SUM(population)&gt;500000000</p> <h3 id="join--on-多表关联查询-1">JOIN … ON 多表关联查询</h3> <p>SELECT games.yr, city.country</p> <p>FROM games JOIN city</p> <p>ON (games.city = city.name)</p> <h3 id="mysql设置权限命令">mysql设置权限命令</h3> <p>GRANT ALL PRIVILEGES ON <em>.</em> TO ‘root’@‘%’ IDENTIFIED BY ‘root’ WITH GRANT OPTION;</p> <h3 id="flush-privileges刷新权限">flush privileges;刷新权限</h3> <h3 id="创建聚合索引">创建聚合索引</h3> <p>CREATE INDEX index_name</p> <p>ON table_name ( column1, column2,…);</p> <h3 id="查询索引">查询索引</h3> <p>SHOW INDEX FROM table_name</p> </article> <div class="post-share"> <div class="container"> <a href="https://twitter.com/share?url=http://localhost:4000/%E5%A4%87%E5%BF%98/2014/05/11/general-mysql-resources.html&text=MySQL常用资源" target="_blank" class="post-share-icon twitter"></a> <a href="https://www.evernote.com/clip.action?url=http://localhost:4000/%E5%A4%87%E5%BF%98/2014/05/11/general-mysql-resources.html&title=MySQL常用资源" target="_blank" class="post-share-icon evernote"></a> <a href="http://service.weibo.com/share/share.php?url=http://localhost:4000/%E5%A4%87%E5%BF%98/2014/05/11/general-mysql-resources.html&title=MySQL常用资源" target="_blank" class="post-share-icon weibo"></a> </div> </div> <!-- <div> <span id="/%E5%A4%87%E5%BF%98/2014/05/11/general-mysql-resources.html" class="leancloud_visitors" data-flag-title="MySQL常用资源"> Visited: <a href="#"><span class="leancloud-visitors-count"></span>次</a> </span> </div> --> <div class="footer"> <div class="container"> <p class="footer-entry">All content is licensed under <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA</a></p> <p class="footer-entry">Buit with <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> and <a href="https://github.com/P233/3-Jekyll" target="_blank">3-Jekyll theme</a> • Hosted on <a href="https://pages.github.com/" target="_blank">Github</a></p> </div> </div> </main> <button id="menu"> <span id="menu-icons"></span> </button> <script src="/assets/js/jquery-2.1.3.min.js"></script> <script src="/assets/js/jquery.pjax.js"></script> <script src="/assets/js/nprogress.js"></script> <script src="/assets/js/main.js"></script> <!-- <script src="https://code.jquery.com/jquery-3.2.0.min.js"></script> <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script> <script>AV.initialize("hsC57we7N9PmKYMU6t3KyweJ-gzGzoHsz", "YQlAC7WFiUBJqltxoXXApj0O");</script> <script> //新增访问次数 function addCount(Counter) { // 页面（博客文章）中的信息：leancloud_visitors // id为page.url， data-flag-title为page.title var $visitors = $(".leancloud_visitors"); var url = $visitors.attr('id').trim(); var title = $visitors.attr('data-flag-title').trim(); var query = new AV.Query(Counter); // 只根据文章的url查询LeanCloud服务器中的数据 query.equalTo("post_url", url); query.find({ success: function(results) { if (results.length > 0) {//说明LeanCloud中已经记录了这篇文章 var counter = results[0]; counter.fetchWhenSave(true); counter.increment("visited_times");// 将点击次数加1 counter.save(null, { success: function(counter) { var $element = $(document.getElementById(url)); var newTimes = counter.get('visited_times'); $element.find('.leancloud-visitors-count').text(newTimes); }, error: function(counter, error) { console.log('Failed to save Visitor num, with error message: ' + error.message); } }); } else { // 执行这里，说明LeanCloud中还没有记录此文章 var newcounter = new Counter(); /* Set ACL */ var acl = new AV.ACL(); acl.setPublicReadAccess(true); acl.setPublicWriteAccess(true); newcounter.setACL(acl); /* End Set ACL */ newcounter.set("post_title", title);// 把文章标题 newcounter.set("post_url", url); // 文章url newcounter.set("visited_times", 1); // 初始点击次数：1次 newcounter.save(null, { // 上传到LeanCloud服务器中 success: function(newcounter) { var $element = $(document.getElementById(url)); var newTimes = newcounter.get('visited_times'); $element.find('.leancloud-visitors-count').text(newTimes); }, error: function(newcounter, error) { console.log('Failed to create'); } }); } }, error: function(error) { console.log('Error:' + error.code + " " + error.message); } }); } //仅根据url和title查出当前访问次数，不做+1操作 function showCount(Counter) { var $visitors = $(".leancloud_visitors"); var url = $visitors.attr('id').trim(); var title = $visitors.attr('data-flag-title').trim(); var query = new AV.Query(Counter); // 只根据文章的url查询LeanCloud服务器中的数据 query.equalTo("post_url", url); query.find({ success: function(results) { if (results.length > 0) {//说明LeanCloud中已经记录了这篇文章 var counter = results[0]; var $element = $(document.getElementById(url)); var newTimes = counter.get('visited_times'); $element.find('.leancloud-visitors-count').text(newTimes); } else { //如果表里没查到记录，那就是异常情况了 console.log('异常情况，不应该没记录的'); } }, error: function(error) { console.log('Error:' + error.code + " " + error.message); } }); } //调用API获取IP function getVisitorIpAndJudge() { var ip; var options = { type: 'POST', dataType: "json", //async: false, //jquery3中可以直接使用回调函数，不用再指定async url: "https://freegeoip.net/json/?callback=?" }; $.ajax(options) .done(function(data, textStatus, jqXHR) { if(textStatus == "success") { ip = data.ip; } judgeVisitor(ip) }); } //判断访客是否已访问过该文章，及访问时间，符合条件则增加一次访问次数 function judgeVisitor(ip) { var Counter = AV.Object.extend("visited_times"); var Visitor = AV.Object.extend("visitors_record"); var $postInfo = $(".leancloud_visitors"); var post_url = $postInfo.attr('id').trim(); var query = new AV.Query(Visitor); query.equalTo("visitor_ip", ip); query.equalTo("post_url", post_url); query.find({ success: function(results) { if (results.length > 0) { console.log('该IP已访问过该文章'); var oldVisitor = results[0]; var lastTime = oldVisitor.updatedAt; var curTime = new Date(); var timePassed = curTime.getTime() - lastTime.getTime(); if(timePassed > 1 * 60 * 1000) { console.log('距离该IP上一次访问该文章已超过了1分钟，更新访问记录，并增加访问次数'); addCount(Counter); oldVisitor.fetchWhenSave(true); oldVisitor.save(null, { success: function(oldVisitor) { }, error: function(oldVisitor, error) { console.log('Failed to save visitor record, with error message: ' + error.message); } }); } else { console.log('这是该IP 1分钟内重复访问该文章，不更新访问记录，不增加访问次数'); showCount(Counter); } } else { console.log('该IP第一次访问该文章，保存新的访问记录，并增加访问次数'); addCount(Counter); var newVisitor = new Visitor(); /* Set ACL */ var acl = new AV.ACL(); acl.setPublicReadAccess(true); acl.setPublicWriteAccess(true); newVisitor.setACL(acl); newVisitor.set("visitor_ip", ip); newVisitor.set("post_url", post_url); newVisitor.save(null, { // 上传到LeanCloud服务器中 success: function(newVisitor) { }, error: function(newVisitor, error) { console.log('Failed to create visitor record, with error message: ' + error.message); } }); } }, error: function(error) { console.log('Error:' + error.code + " " + error.message); addCount(Counter); } }); } $(function() { if ($('.leancloud_visitors').length == 1) { // 文章页面，调用判断方法，对符合条件的访问增加访问次数 getVisitorIpAndJudge(); } else if ($('.post-link').length > 1){ // 首页 暂未使用 // showHitCount(Counter); } }); </script> --> </body> </html>
